---
title: Acceleration Strategies
params:
  data_dir: "/Users/kris/Desktop/data"
  root_dir: "/Users/kris/Desktop/learned_inference"
---

This vignette describes the computation vs. inference tradeoffs associated with
using fine-tuning and coresets while bootstrapping.

```{r}
library("dplyr")
library("ggplot2")
library("readr")
library("stringr")
library("inference")
theme_set(theme_bw() + theme(panel.grid = element_blank()))
params <- list(
  data_dir = "/Users/kris/Desktop/data",
  root_dir = "/Users/kris/Desktop/learned_inference"
)
```

* Get directories to all the fine-tuned features starting at epoch T

The outer loop here goes over different tuning levels. The inner loop gives
different bootstrap results, per tuning level.

```{r}
features_dirs <- list(
  "tune_60" = file.path(params$data_dir, "features", "vae_tune_60"),
  "tune_50" = file.path(params$data_dir, "features", "vae_tune_50"),
  "tune_40" = file.path(params$data_dir, "features", "vae_tune_40"),
  "tune_30" = file.path(params$data_dir, "features", "vae_tune_30"),
  "tune_20" = file.path(params$data_dir, "features", "vae_tune_20")
  ## "tune_10" = file.path(params$data_dir, "features", "vae_tune_10"),
  ## "tune_0" = file.path(params$data_dir, "features", "vae_tune_0")
)

features_list <- list()
for (i in seq_along(features_dirs)) {
  cur_dir <- names(features_dirs)[i]
  print(cur_dir)

  features_paths <- list.files(features_dirs[[i]], "*.csv", full.names = TRUE)
  features_list[[cur_dir]] <- list()

  for (p in features_paths) {
    features_list[[cur_dir]][[p]] <- read_csv(p) %>%
      select(path, model, img_id, everything()) %>%
      select(-img_id, -y)
    features_list[[cur_dir]][[p]]$ix <- gsub(".npy", "", features_list[[cur_dir]][[p]]$path) %>%
      str_extract("[0-9]+$") %>%
      as.integer()
    features_list[[cur_dir]][[p]] <- features_list[[cur_dir]][[p]] %>%
      arrange(ix)
  }
}
```

* Calculate pairwise RVs

```{r}
z <- list()
rvs <- list()
for (i in seq_along(features_list)) {
  cur_dir <- names(features_list)[i]
  z[[cur_dir]] <- lapply(features_list[[i]], function(y) as.matrix(y[, 4:67]))
  rvs[[cur_dir]] <- pairwise_rv(z[[cur_dir]])
}

mrvs <- melt(rvs)
colnames(mrvs) <- c("i", "j", "value", "tune_level")

ggplot(mrvs %>% filter(value > 0)) +
  geom_histogram(aes(x = value), binwidth = 0.005) +
  labs(x = "Pairwise RV Coefficients") +
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(tune_level ~ .)

features_list$tune_50 %>%head()
features_list$start_10$"/Users/kris/Desktop/data/features/vae_tune_10/features_None.csv" %>%
  .[["model"]]
```

* Get pairwise RVs for features at each epoch level
* Put into a list element
* Melt into appropriate data frame and look at histogram
