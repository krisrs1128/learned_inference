---
title: "Visualize Learned Features"
output: html_notebook
params:
  output_path: "/Users/kris/Downloads/figures/"
  tiles_dir: "/Users/kris/Documents/stability_data"
---

This notebook includes helpers for visualizing the learned aligned features
$\mathbf{Z}_{b}$.

```{r}
library("ggplot2")
library("inference")
library("dplyr")
theme_set(theme_bw())
dpath <- function(s, d=params$output_path) {
  file.path(d, s)
}
```

First, read in all the aligned features, their centroids, and edges between
features and centroids.

```{r}
# directory containing unzipped figure results
edge_data <- dir(params$output_path, "edge_data_svd*", recursive = TRUE, full = TRUE) %>%
  map_dfr(read_csv, col_types = cols(), .id = "method")
edge_data$method <- c("CNN", "RCF", "VAE")[as.numeric(edge_data$method)]
centroids <- dir(params$output_path, "centroids_svd*", recursive = TRUE, full = TRUE) %>%
  map_dfr(read_csv, col_types = cols(), .id = "method")
centroids$method <- c("CNN", "RCF", "VAE")[as.numeric(centroids$method)]
paths <- sapply(centroids$rel_path, dpath, d = params$tiles_dir)
j1 <- 2
j2 <- 1
```

Overlay example patches on the observed coordinates.

```{r}
cur_cols <- paste0("meandim", c(j1, j2))
p <- list()
for (m in c("CNN", "RCF", "VAE")) {
  coords <- centroids %>%
    filter(
      split == "test",
      method == m
    ) %>%
    select(one_of(cur_cols))
  colnames(coords) <- c("x", "y")
  imsize <- diff(range(coords$y)) / 14.5
  p[[m]] <- image_grid(coords, paths, min_dist = 1, density = c(12, 14), imsize = imsize) +
    labs(
      x = sprintf("Learned Feature %s", j1),
      y = sprintf("Learned Feature %s", j2)
    ) +
    scale_fill_manual(values = c("red", "green", "blue")) +
    theme(panel.grid.minor = element_blank())
}
```

```{r, fig.height = 4, fig.width = 12}
library("gridExtra")
ga <- grid.arrange(
  p[[1]] + ggtitle("CNN"), 
  p[[2]] + ggtitle("RCF"), 
  p[[3]] + ggtitle("VAE"), 
  ncol = 3
)
ggsave("~/Desktop/conceptual/learned_inference/notes/figure/sim_imagegrid-1-2.png", ga, dpi = 500)
```

Consider the original discrepancies between features and their centroids.

```{r, fig.height = 18, fig.width = 12}
edge_data_ <- edge_data %>%
  #filter(split == "test") %>%
  split(.$method) %>%
  map_dfr(~ .x %>% filter(rel_path %in% unique(.x$rel_path)[1:400])) %>%
  mutate(split = factor(split, levels = c("train", "dev", "test")))

centroids <- centroids %>%
  mutate(split = factor(split, levels = c("train", "dev", "test")))

ggplot(edge_data_) +
  geom_point(
    data = centroids %>% filter(rel_path %in% edge_data_$rel_path),
    aes_string(x = paste0("meandim", j1), y = paste0("meandim", j2), col = "y"),
    alpha = .5, size = 0.6
    ) +
  geom_point(
    aes_string(x = paste0("dim", j1), y = paste0("dim", j2), col = "y"),
    size = 0.4, alpha = 0.8, shape = 4
  ) +
  geom_segment(
    aes_string(x = paste0("meandim", j1), xend = paste0("dim", j1), y = paste0("meandim", j2), yend = paste0("dim", j2), col = "y"),
    size = 0.3, alpha = 0.8
  ) +
  facet_wrap(split ~ method, scale = "free") +
  #facet_wrap(. ~ method, scale = "free") +
  scale_color_viridis_c() +
  labs(x = sprintf("Learned Feature %s", j1), y = sprintf("Learned Feature %s", j2)) +
  theme(legend.position = "bottom")
ggsave("~/Desktop/conceptual/learned_inference/notes/figure/embeddings50-all-svd-1-2.png", dpi = 500)
```
And place into context by showing all samples in one figure.

```{r, fig.height = 10, fig.width = 7.5}
ggplot(centroids) +
  geom_point(
    data = centroids,
    aes_string(x = paste0("meandim", j1), y = paste0("meandim", j2), col = "y"),
    alpha = .8, size = 0.5
    ) +
  facet_wrap(split ~ method, scale = "free") +
  scale_color_viridis_c() +
  labs(x = sprintf("Learned Feature %s", j1), y = sprintf("Learned Feature %s", j2)) +
  theme(legend.position = "bottom")
ggsave("~/Desktop/conceptual/learned_inference/notes/figure/embeddings50-all-all-svd-1-2.png", dpi = 500)
```
